<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link
    rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='90' font-size='90'%3EüèéÔ∏è%3C/text%3E%3C/svg%3E"
  >
  <title>F1 Fantasy Team Optimiser</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script>
    const serverConfig = {{ user_config|tojson|safe }};
    const simpleMatrix = {{ simple_matrix|tojson|safe }};
    const autoEmailOptIn = {{ 'true' if auto_email else 'false' }};
  </script>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>F1 Fantasy Team Optimiser</h1>
      <button class="nav-toggle" onclick="toggleNav()">&#9776;</button>
      <nav class="nav-links">
        {% if current_user.is_authenticated %}
          <a href="/">Home</a>
          <a href="/optimizer" class="active">Optimiser</a>
          <a href="/statistics">Statistics</a>
          {% if current_user.admin %}
          <a href="/manage_data">Administration</a>
          {% endif %}
          <a href="/account">Account</a>
          <a href="/logout">Logout</a>
        {% else %}
          <a href="/">Home</a>
          <a href="/login">Login</a>
        {% endif %}
      </nav>
    </div>
  </header>

  <div class="container">


    <!-- Configuration Section -->
    <div class="section" id="config-section" style="display: none; position: relative;">
      <h2>Configure Optimisation</h2>

      <div class="config-mode-toggle">
        <label for="config-toggle">Advanced</label>
        <label class="switch">
          <input type="checkbox" id="config-toggle" onchange="toggleConfigMode()">
          <span class="slider round"></span>
        </label>
      </div>

      <div class="form-group">
        <label>Races Completed: <span id="races-completed">-</span></label>
      </div>

      <h3 style="margin: 20px 0 10px;">Current Team</h3>
      <div class="team-selection">
        <div>
          <label>Drivers (Select 5)</label>
          <div id="driver-selects">
            <!-- Driver dropdowns will be added here -->
          </div>
        </div>
        <div>
          <label>Constructors (Select 2)</label>
          <div id="constructor-selects">
            <!-- Constructor dropdowns will be added here -->
          </div>
        </div>
      </div>

      <div style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;">
        <div class="form-group">
          <label for="remaining-budget">Remaining Budget (M)</label>
          <input type="number" id="remaining-budget" value="1.0" step="0.1" min="0">
        </div>

        <div class="form-group">
          <label for="step1-swaps">Available Swaps</label>
          <input type="number" id="step1-swaps" value="2" min="0" max="7">
        </div>



        

      </div>

      <div id="simple-config" style="display:none;">
        <label for="simple-slider">Risk Level: <span id="simple-slider-label"></span></label>
        <input type="range" id="simple-slider" min="1" max="5" step="1" value="3" oninput="updateSimpleLabel(this.value)" onchange="applySimpleConfig(this.value)">
        <div class="slider-labels" style="display:flex; justify-content:space-between; font-size:0.9em;">
          <span>Low Risk</span><span>High Risk</span>
        </div>
      </div>

      <!-- FP2 Race Pace Configuration -->
        <div class="fp2-config" id="advanced-config">
          <h3>Advanced Configuration</h3>
          <div class="fp2-grid">
            <div class="form-group">
              <label for="pace-weight">Pace Weight</label>
              <select id="pace-weight">
              <option value="0.20">Conservative (20% current, 80% historical)</option>
              <option value="0.25">Conservative-Medium (25% current, 75% historical)</option>
              <option value="0.30" selected>Balanced (30% current, 70% historical)</option>
              <option value="0.35">Balanced-Aggressive (35% current, 65% historical)</option>
              <option value="0.40">Aggressive (40% current, 60% historical)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="pace-modifier-type">Pace Modifier Type</label>
            <select id="pace-modifier-type">
              <option value="conservative" selected>Conservative (0.8√ó to 1.2√ó)</option>
              <option value="aggressive">Aggressive (0.6√ó to 1.4√ó)</option>
            </select>
          </div>

            <div class="form-group">
              <label for="weighting-scheme">Past Performance Weighting</label>
              <select id="weighting-scheme">
                <option value="trend_based">Trend-based (Adaptive)</option>
                <option value="equal">Equal weights</option>
                <option value="linear_decay">Linear decay</option>
                <option value="moderate_decay">Moderate decay</option>
                <option value="exp_decay" selected>Exponential decay</option>
              </select>
            </div>

            <div class="form-group">
              <label for="risk-tolerance">Risk Tolerance</label>
              <select id="risk-tolerance">
                <option value="low">Low (Consistent performers)</option>
                <option value="medium" selected>Medium (Balanced)</option>
                <option value="high">High (Track-specific)</option>
              </select>
            </div>
          </div>
        </div>

      <div class="button-group">
        <button class="button" onclick="runOptimization()">Run Optimisation</button>
        <button class="button" onclick="scheduleOptimization()">Schedule Email Optimisation</button>
      </div>
    </div>

    <!-- Progress Section -->
    <div class="section" id="progress-section">
      <h2>Optimisation Progress</h2>
      <div class="loading">
        <div class="spinner"></div>
        <p>Running optimisation‚Ä¶</p>
      </div>
      <div id="progress-messages"></div>
    </div>

    <!-- Results Section -->
    <div class="section results" id="results-section">
      <h2>Optimisation Results</h2>
      <div id="results-content"></div>
    </div>
  </div>

  <script>
    let sessionId = null;
    let sessionData = null;
    let usingDefaultData = false;

    window.addEventListener('DOMContentLoaded', async function() {
      try {
        const hasDefault = await checkDefaultData();
        await checkDriverMapping();

        if (hasDefault) {
          useDefaultData();
        } else {
          document.getElementById('config-section').style.display = 'none';
        }

      } catch (error) {
        console.error('Error during page initialization:', error);
      }
    });

    async function checkDefaultData() {
      try {
        const response = await fetch('/check_default_data');
        if (!response.ok) {
          const text = await response.text();
          throw new Error(`Status ${response.status}: ${text}`);
        }
        const data = await response.json();
        return data.has_default;
      } catch (error) {
        console.error('Error checking default data:', error);
        return false;
      }
    }

    async function checkDriverMapping() {
      try {
        const response = await fetch('/check_driver_mapping');
        const data = await response.json();
        const statusDiv = document.getElementById('mapping-status');
        if (statusDiv) {
          if (data.exists) {
            statusDiv.innerHTML = '<div class="success">‚úÖ Driver mapping is available.</div>';
          } else {
            statusDiv.innerHTML = '<div class="warning">‚ö†Ô∏è No driver mapping file found. Upload one to enable Race Pace Estimation.</div>';
          }
        }
        return data.exists;
      } catch (error) {
        console.error('Error checking driver mapping:', error);
        return false;
      }
    }

    function showDriverMapping() {
      const section = document.getElementById('driver-mapping-section');
      if (section) {
        section.style.display = 'block';
      }
    }

    function showUploadSection() {
      const configSection = document.getElementById('config-section');
      if (configSection) configSection.style.display = 'none';
      const uploadSection = document.getElementById('upload-section');
      if (uploadSection) uploadSection.style.display = 'block';
      const resultsSection = document.getElementById('results-section');
      if (resultsSection) resultsSection.style.display = 'none';
      const defaultStatus = document.getElementById('default-data-status');
      if (defaultStatus) defaultStatus.style.display = 'none';

      const driverInput = document.getElementById('driver-data');
      if (driverInput) driverInput.value = '';
      const consInput = document.getElementById('constructor-data');
      if (consInput) consInput.value = '';
      const calInput = document.getElementById('calendar-data');
      if (calInput) calInput.value = '';
      const tracksInput = document.getElementById('tracks-data');
      if (tracksInput) tracksInput.value = '';
      const updateChk = document.getElementById('update-default-checkbox');
      if (updateChk) updateChk.checked = false;
    }

    async function useDefaultData() {
      fetch('/check_default_data')
        .then(async response => {
          if (!response.ok) {
            const text = await response.text();
            throw new Error(`Status ${response.status}: ${text}`);
          }
          return response.json();
        })
        .then(data => {
          if (!data.has_default) return;

          sessionId         = 'default';
          sessionData       = data.data;
          usingDefaultData  = true;

          const racesCompletedEl = document.getElementById('races-completed');
          if (racesCompletedEl) {
            racesCompletedEl.textContent = data.data.races_completed;
          }

          populateTeamSelects(data.data.drivers, data.data.constructors);
          loadConfig();

          document.getElementById('config-section').style.display = 'block';
          const uploadSection = document.getElementById('upload-section');
          if (uploadSection) {
            uploadSection.style.display = 'none';
          }

          checkDriverMapping();
        })
        .catch(error => {
          alert('Error loading default data: ' + error.message);
        });
    }

    function populateTeamSelects(drivers, constructors) {
      const driverContainer = document.getElementById('driver-selects');
      if (driverContainer) {
        driverContainer.innerHTML = '';
        for (let i = 0; i < 5; i++) {
          const select = document.createElement('select');
          select.className = 'driver-select';
          select.innerHTML = '<option value="">Select driver‚Ä¶</option>';
          drivers.forEach(driver => {
            select.innerHTML += `<option value="${driver}">${driver}</option>`;
          });
          select.addEventListener('change', validateUniqueSelections);
          driverContainer.appendChild(select);
        }
      }

      const constructorContainer = document.getElementById('constructor-selects');
      if (constructorContainer) {
        constructorContainer.innerHTML = '';
        for (let i = 0; i < 2; i++) {
          const select = document.createElement('select');
          select.className = 'constructor-select';
          select.innerHTML = '<option value="">Select constructor‚Ä¶</option>';
          constructors.forEach(cons => {
            select.innerHTML += `<option value="${cons}">${cons}</option>`;
          });
          select.addEventListener('change', validateUniqueSelections);
          constructorContainer.appendChild(select);
        }
      }

      validateUniqueSelections();
      toggleConfigMode();
    }

    function validateUniqueSelections() {
      const drivers = [];
      document.querySelectorAll('.driver-select').forEach(sel => drivers.push(sel.value));
      const driverDuplicates = drivers.filter((val, idx, arr) => val && arr.indexOf(val) !== idx);
      document.querySelectorAll('.driver-select').forEach(sel => {
        if (driverDuplicates.includes(sel.value) && sel.value) {
          sel.classList.add('duplicate-selection');
        } else {
          sel.classList.remove('duplicate-selection');
        }
      });

      const constructors = [];
      document.querySelectorAll('.constructor-select').forEach(sel => constructors.push(sel.value));
      const consDuplicates = constructors.filter((val, idx, arr) => val && arr.indexOf(val) !== idx);
      document.querySelectorAll('.constructor-select').forEach(sel => {
        if (consDuplicates.includes(sel.value) && sel.value) {
          sel.classList.add('duplicate-selection');
        } else {
          sel.classList.remove('duplicate-selection');
        }
      });

      return driverDuplicates.length === 0 && consDuplicates.length === 0;
    }

    function setCookie(name, value, days = 30) {
      const expires = new Date();
      expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
      document.cookie = `${name}=${JSON.stringify(value)};expires=${expires.toUTCString()};path=/`;
    }

    function getCookie(name) {
      const nameEQ = name + '=';
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1);
        if (c.indexOf(nameEQ) === 0) {
          try {
            return JSON.parse(c.substring(nameEQ.length));
          } catch {
            return null;
          }
        }
      }
      return null;
    }

    function updateSimpleLabel(val) {
      const labels = ['Low Risk','Low-Med','Medium','Med-High','High Risk'];
      document.getElementById('simple-slider-label').textContent = labels[val-1] || '';
    }

    function applySimpleConfig(val) {
      const idx = parseInt(val) - 1;
      if (!simpleMatrix || !simpleMatrix[idx]) return;
      const m = simpleMatrix[idx];
      if (m.pace_weight)        document.getElementById('pace-weight').value = m.pace_weight;
      if (m.pace_modifier_type) document.getElementById('pace-modifier-type').value = m.pace_modifier_type;
      if (m.weighting_scheme)   document.getElementById('weighting-scheme').value = m.weighting_scheme;
      if (m.risk_tolerance)     document.getElementById('risk-tolerance').value = m.risk_tolerance;
      saveConfigToCookie();
    }

    function toggleConfigMode() {
      const isAdvanced = document.getElementById('config-toggle').checked;
      const mode = isAdvanced ? 'advanced' : 'simple';
      document.getElementById('simple-config').style.display = isAdvanced ? 'none' : 'block';
      document.getElementById('advanced-config').style.display = isAdvanced ? 'block' : 'none';
      if (!isAdvanced) applySimpleConfig(document.getElementById('simple-slider').value);
    }

    function saveConfigToCookie() {
      const drivers = [];
      document.querySelectorAll('.driver-select').forEach(sel => {
        if (sel.value) drivers.push(sel.value);
      });
      const constructors = [];
      document.querySelectorAll('.constructor-select').forEach(sel => {
        if (sel.value) constructors.push(sel.value);
      });
      const config = {
        current_drivers:       drivers,
        current_constructors:  constructors,
        remaining_budget:      document.getElementById('remaining-budget')?.value,
        step1_swaps:           document.getElementById('step1-swaps')?.value,
        weighting_scheme:      document.getElementById('weighting-scheme')?.value,
        risk_tolerance:        document.getElementById('risk-tolerance')?.value,
        multiplier:            2,
        config_mode:           document.getElementById('config-toggle').checked ? 'advanced' : 'simple',
        simple_slider:         document.getElementById('simple-slider')?.value,
        use_fp2_pace:          true,
        pace_weight:           document.getElementById('pace-weight')?.value,
        pace_modifier_type:    document.getElementById('pace-modifier-type')?.value
      };
      setCookie('f1_optimizer_config', config);
    }

    function loadConfigFromCookie() {
      const config = getCookie('f1_optimizer_config');
      if (config) applyConfig(config);
    }

    function loadConfig() {
      if (serverConfig) {
        applyConfig(serverConfig);
        setCookie('f1_optimizer_config', serverConfig);
      } else {
        loadConfigFromCookie();
      }
    }

    function applyConfig(config) {
      const driverSelects = document.querySelectorAll('.driver-select');
      if (config.current_drivers) {
        config.current_drivers.forEach((driver, idx) => {
          if (driverSelects[idx]) driverSelects[idx].value = driver;
        });
      }
      const constructorSelects = document.querySelectorAll('.constructor-select');
      if (config.current_constructors) {
        config.current_constructors.forEach((cons, idx) => {
          if (constructorSelects[idx]) constructorSelects[idx].value = cons;
        });
      }
      if (config.remaining_budget) document.getElementById('remaining-budget').value = config.remaining_budget;
      if (config.step1_swaps)       document.getElementById('step1-swaps').value       = config.step1_swaps;
      if (config.weighting_scheme)  document.getElementById('weighting-scheme').value  = config.weighting_scheme;
      if (config.risk_tolerance)    document.getElementById('risk-tolerance').value    = config.risk_tolerance;
        if (config.config_mode) {
          document.getElementById("config-toggle").checked = (config.config_mode === "advanced");
        }
        if (config.simple_slider) {
          document.getElementById("simple-slider").value = config.simple_slider;
          updateSimpleLabel(config.simple_slider);
        }

      if (config.pace_weight)        document.getElementById('pace-weight').value       = config.pace_weight;
      if (config.pace_modifier_type) document.getElementById('pace-modifier-type').value = config.pace_modifier_type;

      validateUniqueSelections();
      toggleConfigMode();
    }

    async function uploadFiles() {
      const files = {
        'calendar.csv': document.getElementById('calendar-data')?.files[0],
        'tracks.csv':   document.getElementById('tracks-data')?.files[0]
      };

      let allFilesSelected = true;
      for (const file of Object.values(files)) {
        if (!file) {
          allFilesSelected = false;
          break;
        }
      }
      if (!allFilesSelected) {
        alert('Please select both required CSV files');
        return;
      }

      const formData = new FormData();
      for (const [name, file] of Object.entries(files)) {
        formData.append(name, file, name);
      }
      const updateDefault = document.getElementById('update-default-checkbox')?.checked;
      formData.append('update_default', updateDefault);

      try {
        const response = await fetch('/upload', {
          method: 'POST',
          body:   formData
        });
        const data = await response.json();
        if (!data.success) {
          alert('Error: ' + data.message);
          return;
        }

        sessionId   = data.session_id;
        sessionData = data;
        usingDefaultData = false;

        document.getElementById('races-completed').textContent = data.races_completed;
        populateTeamSelects(data.drivers, data.constructors);

        const driverMappingFile = document.getElementById('driver-mapping-file')?.files[0];
        if (driverMappingFile) {
          await uploadDriverMappingFile(driverMappingFile);
        }

        if (data.updated_default) {
          alert('Files uploaded and saved as default data successfully!');
          await checkDefaultData();
          await checkDriverMapping();
        } else {
          alert('Files uploaded successfully!');
        }

        loadConfig();
        document.getElementById('config-section').style.display = 'block';
        document.getElementById('upload-section').style.display = 'none';
      } catch (error) {
        alert('Error uploading files: ' + error.message);
      }
    }

    async function uploadDriverMappingFile(file) {
      const formData = new FormData();
      formData.append('driver_mapping', file);
      try {
        const response = await fetch('/upload_driver_mapping', {
          method: 'POST',
          body:   formData
        });
        const data = await response.json();
        const statusDiv = document.getElementById('mapping-status');
        if (data.success) {
          statusDiv.innerHTML = `<div class="success">‚úÖ ${data.message}</div>`;
        } else {
          statusDiv.innerHTML = `<div class="error">‚ùå ${data.message}</div>`;
        }
      } catch (error) {
        document.getElementById('mapping-status').innerHTML =
          `<div class="error">‚ùå Error uploading driver mapping: ${error.message}</div>`;
      }
    }

    async function runOptimization() {
      validateUniqueSelections();
      toggleConfigMode();
      const drivers = [];
      document.querySelectorAll('.driver-select').forEach(sel => {
        if (sel.value) drivers.push(sel.value);
      });
      if (drivers.length !== 5) {
        alert('Please select exactly 5 drivers');
        return;
      }
      if (new Set(drivers).size !== drivers.length) {
        alert('Each driver must be unique');
        return;
      }

      const constructors = [];
      document.querySelectorAll('.constructor-select').forEach(sel => {
        if (sel.value) constructors.push(sel.value);
      });
      if (constructors.length !== 2) {
        alert('Please select exactly 2 constructors');
        return;
      }
      if (new Set(constructors).size !== constructors.length) {
        alert('Each constructor must be unique');
        return;
      }

      const useFP2 = true;
      const mappingCheck = await fetch('/check_driver_mapping');
      const mappingData  = await mappingCheck.json();
      if (!mappingData.exists) {
        alert('Driver mapping file is required for Race Pace Estimation. Please upload it first.');
        return;
      }

      const config = {
        session_id:          sessionId,
        current_drivers:     drivers,
        current_constructors: constructors,
        remaining_budget:    document.getElementById('remaining-budget')?.value,
        step1_swaps:         document.getElementById('step1-swaps')?.value,
        weighting_scheme:    document.getElementById('weighting-scheme')?.value,
        risk_tolerance:      document.getElementById('risk-tolerance')?.value,
        multiplier:          2,
        use_fp2_pace:        useFP2,
        pace_weight:         parseFloat(document.getElementById('pace-weight')?.value),
        pace_modifier_type:  document.getElementById('pace-modifier-type')?.value
      };

      saveConfigToCookie();

      document.getElementById('progress-section').style.display = 'block';
      document.getElementById('results-section').style.display  = 'none';

      try {
        const response = await fetch('/optimize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        const data = await response.json();
        if (data.success) {
          displayResults(data);
        } else {
          alert('Error: ' + data.message);
        }
      } catch (error) {
        alert('Error running optimization: ' + error.message);
      } finally {
        document.getElementById('progress-section').style.display = 'none';
      }
    }

    async function scheduleOptimization() {
      validateUniqueSelections();
      toggleConfigMode();
      const drivers = [];
      document.querySelectorAll('.driver-select').forEach(sel => { if (sel.value) drivers.push(sel.value); });
      if (drivers.length !== 5) { alert('Please select exactly 5 drivers'); return; }
      if (new Set(drivers).size !== drivers.length) { alert('Each driver must be unique'); return; }
      const constructors = [];
      document.querySelectorAll('.constructor-select').forEach(sel => { if (sel.value) constructors.push(sel.value); });
      if (constructors.length !== 2) { alert('Please select exactly 2 constructors'); return; }
      if (new Set(constructors).size !== constructors.length) { alert('Each constructor must be unique'); return; }
      const useFP2 = true;
      const config = {
        session_id: sessionId,
        current_drivers: drivers,
        current_constructors: constructors,
        remaining_budget: document.getElementById('remaining-budget')?.value,
        step1_swaps: document.getElementById('step1-swaps')?.value,
        weighting_scheme: document.getElementById('weighting-scheme')?.value,
        risk_tolerance: document.getElementById('risk-tolerance')?.value,
        multiplier: 2,
        use_fp2_pace: useFP2,
        pace_weight: parseFloat(document.getElementById('pace-weight')?.value),
        pace_modifier_type: document.getElementById('pace-modifier-type')?.value
      };
      saveConfigToCookie();
      try {
        if (autoEmailOptIn) {
          const update = confirm('You are currently opted in for automatic email optimisations.\nOK to update defaults, Cancel for one-off.');
          if (update) {
            const r = await fetch('/auto_email_config', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ opt_in: true, config })
            });
            if ((await r.json()).success) {
              alert('Default optimisation settings updated.');
            }
            return;
          }
        } else {
          const opt = confirm('Opt-in to receive optimisations for every race?');
          if (opt) {
            const r = await fetch('/auto_email_config', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ opt_in: true, config })
            });
            if ((await r.json()).success) {
              alert('Automatic email optimisation enabled.');
              autoEmailOptIn = true;
            }
            return;
          }
        }

        const resp = await fetch('/schedule_optimization', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        const data = await resp.json();
        if (data.success) {
          alert('Optimisation scheduled. Results will be emailed to you.');
        } else {
          alert('Error: ' + data.message);
        }
      } catch (err) {
        alert('Error scheduling optimisation: ' + err.message);
      }
    }

    function displayResults(data) {
      const resultsContent = document.getElementById('results-content');
      const opt = data.optimization;
      let fp2InfoHtml = '';

      // Only show FP2 block if ‚Äúapplied‚Äù is true
      if (opt.fp2_info && opt.fp2_info.applied) {
        fp2InfoHtml = `
          <div class="result-card" style="border-left-color: #17a2b8;">
            <h3>Race Pace Estimation</h3>
            <p><strong>Pace Weight:</strong> ${(opt.fp2_info.pace_weight * 100).toFixed(0)}% current form, ${(100 - opt.fp2_info.pace_weight * 100).toFixed(0)}% historical</p>
            <p><strong>Modifier Type:</strong> ${opt.fp2_info.modifier_type}</p>
            <p style="color: #28a745; font-weight: bold;">‚úÖ FP2 Lap data successfully integrated</p>
            ${opt.fp2_info.pace_adjustments && opt.fp2_info.pace_adjustments.length > 0 ? `
              <h4>Pace Adjustments for Current Team:</h4>
              ${opt.fp2_info.pace_adjustments.map(adj => `
                <div class="pace-adjustment">
                  <span>${adj.driver}</span>
                  <span class="pace-score">
                    Score: ${adj.pace_score} | 
                    Modifier: ${adj.pace_modifier}√ó | 
                    VFM: ${adj.vfm_original} ‚Üí ${adj.vfm_adjusted}
                  </span>
                </div>
              `).join('')}
            ` : ''}
          </div>
        `;
      }

      const html = `
        ${fp2InfoHtml}
        <div class="result-card">
          <h3>Next Race: ${opt.step1.circuit}</h3>
          ${opt.step1.swaps.length > 0 ? `
            <h4>Recommended Swaps:</h4>
            ${opt.step1.swaps.map(swap => `
              <div class="swap-item">
                <span>${swap[0]}: ${swap[1]} ‚Üí ${swap[2]}</span>
              </div>
            `).join('')}
          ` : '<p>No swaps recommended</p>'}
          <p><strong>Expected Points:</strong> ${opt.step1.expected_points.toFixed(1)} 
             <span class="improvement">(+${opt.step1.improvement.toFixed(1)})</span></p>
          <p><strong>Boost Driver:</strong> ${opt.step1.boost_driver}</p>
        </div>

        <div class="result-card">
          <h3>Following Race: ${opt.step2.circuit}</h3>
          ${opt.step2.swaps.length > 0 ? `
            <h4>Additional Swaps:</h4>
            ${opt.step2.swaps.map(swap => `
              <div class="swap-item">
                <span>${swap[0]}: ${swap[1]} ‚Üí ${swap[2]}</span>
              </div>
            `).join('')}
          ` : '<p>No additional swaps</p>'}
          <p><strong>Expected Points:</strong> ${opt.step2.expected_points.toFixed(1)} 
             <span class="improvement">(+${opt.step2.improvement.toFixed(1)})</span></p>
          <p><strong>Boost Driver:</strong> ${opt.step2.boost_driver}</p>
          <p><strong>Budget:</strong> ${opt.step2.budget_used.toFixed(1)}M used,
             ${opt.step2.budget_remaining.toFixed(1)}M remaining</p>
        </div>

        <div class="result-card">
          <h3>Final Team</h3>
          <h4>Drivers:</h4>
          <div class="team-display">
            ${opt.step2.team.drivers.map(d => `<div class="team-member">${d}</div>`).join('')}
          </div>
          <h4>Constructors:</h4>
          <div class="team-display">
            ${opt.step2.team.constructors.map(c => `<div class="team-member">${c}</div>`).join('')}
          </div>
        </div>

        <div class="result-card">
          <h3>Summary</h3>
          <p><strong>Total Improvement:</strong> <span class="improvement">+${opt.summary.total_improvement.toFixed(1)} points</span></p>
          <p><strong>Patterns Evaluated:</strong> ${opt.summary.patterns_evaluated.toLocaleString()}</p>
          <p><strong>Optimization Time:</strong> ${opt.summary.optimization_time.toFixed(1)}s</p>
          ${opt.fp2_info && opt.fp2_info.applied ?
            '<p style="color: #17a2b8;"><strong>Enhancement:</strong> FP2-derived race pace estimations</p>' :
            '<p style="color: #6c757d;"><strong>Analysis:</strong> Historical data only</p>'
          }
        </div>
      `;
      resultsContent.innerHTML = html;
  document.getElementById('results-section').style.display = 'block';
  }
  </script>
  <script>
    function toggleNav() {
      document.querySelector('.nav-links').classList.toggle('open');
    }
  </script>
</body>
</html>
