{% extends "base.html" %}
{% block title %}Administration{% endblock %}
{% block content %}
  <div class="container">
    {% if message %}
    <div class="info">{{ message }}</div>
    {% endif %}
    <details class="admin-section">
      <summary>Driver Race Data</summary>
      <div class="section">
      <form method="post" action="/save_driver_data" onsubmit="prepareDriverCsv()">
        <input type="file" accept=".csv" onchange="loadCsv(event,'driver-table')" />
        <table id="driver-table" class="data-table"></table>
        <input type="hidden" name="driver_data" id="driver-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('driver-table')">Add Row</button>
          <button type="button" class="button-secondary" onclick="addColumn('driver-table')">Add Column</button>
          <button class="button" type="submit">Save Drivers</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>Constructor Race Data</summary>
      <div class="section">
      <form method="post" action="/save_constructor_data" onsubmit="prepareConstructorCsv()">
        <input type="file" accept=".csv" onchange="loadCsv(event,'constructor-table')" />
        <table id="constructor-table" class="data-table"></table>
        <input type="hidden" name="constructor_data" id="constructor-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('constructor-table')">Add Row</button>
          <button type="button" class="button-secondary" onclick="addColumn('constructor-table')">Add Column</button>
          <button class="button" type="submit">Save Constructors</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>Race Calendar</summary>
      <div class="section">
      <form method="post" action="/save_calendar_data" onsubmit="prepareCalendarCsv()">
        <input type="file" accept=".csv" onchange="loadCsv(event,'calendar-table')" />
        <table id="calendar-table" class="data-table"></table>
        <input type="hidden" name="calendar_data" id="calendar-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('calendar-table')">Add Row</button>
          <button type="button" class="button-secondary" onclick="addColumn('calendar-table')">Add Column</button>
          <button class="button" type="submit">Save Calendar</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>Tracks</summary>
      <div class="section">
      <form method="post" action="/save_tracks_data" onsubmit="prepareTracksCsv()">
        <input type="file" accept=".csv" onchange="loadCsv(event,'tracks-table')" />
        <table id="tracks-table" class="data-table"></table>
        <input type="hidden" name="tracks_data" id="tracks-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('tracks-table')">Add Row</button>
          <button type="button" class="button-secondary" onclick="addColumn('tracks-table')">Add Column</button>
          <button class="button" type="submit">Save Tracks</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>Driver Mapping</summary>
      <div class="section">
      <form method="post" action="/save_mapping_data" onsubmit="prepareMappingCsv()">
        <input type="file" accept=".csv" onchange="loadCsv(event,'mapping-table')" />
        <table id="mapping-table" class="data-table"></table>
        <input type="hidden" name="mapping_data" id="mapping-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('mapping-table')">Add Row</button>
          <button type="button" class="button-secondary" onclick="addColumn('mapping-table')">Add Column</button>
          <button class="button" type="submit">Save Mapping</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>Simple Config Matrix</summary>
      <div class="section">
      <form method="post" action="/save_simple_matrix" onsubmit="prepareSimpleMatrixCsv()">
        <input type="file" accept=".csv" onchange="loadCsv(event,'simple-matrix-table')" />
        <table id="simple-matrix-table" class="data-table"></table>
        <input type="hidden" name="simple_matrix_data" id="simple-matrix-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('simple-matrix-table')">Add Row</button>
          <button type="button" class="button-secondary" onclick="addColumn('simple-matrix-table')">Add Column</button>
          <button class="button" type="submit">Save Matrix</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>Queued Optimisations</summary>
      <div class="section">
        <table id="tasks-table" class="data-table"></table>
      </div>
    </details>
  </div>
{% endblock %}
{% block scripts %}
  <script>
    const driverCSV = {{ driver_csv|tojson|safe }};
    const constructorCSV = {{ constructor_csv|tojson|safe }};
    const calendarCSV = {{ calendar_csv|tojson|safe }};
    const tracksCSV = {{ tracks_csv|tojson|safe }};
    const mappingCSV = {{ mapping_csv|tojson|safe }};
    const simpleMatrixCSV = {{ simple_matrix_csv|tojson|safe }};

    function parseCSV(text) {
      return text.trim().split(/\r?\n/).map(r => r.split(','));
    }

    function buildTable(csv, tableId) {
      const rows = csv ? parseCSV(csv) : [];
      const table = document.getElementById(tableId);
      table.innerHTML = '';
      if (!rows.length) return;
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      rows[0].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      for (let i = 1; i < rows.length; i++) {
        const tr = document.createElement('tr');
        rows[i].forEach(cell => {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'text';
          input.value = cell;
          td.appendChild(input);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
    }

    function tableToCSV(tableId) {
      const table = document.getElementById(tableId);
      const rows = [];
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
      rows.push(headers.join(','));
      table.querySelectorAll('tbody tr').forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('td input')).map(inp => inp.value);
        rows.push(cells.join(','));
      });
      return rows.join('\n');
    }

    function addRow(tableId) {
      const table = document.getElementById(tableId);
      const row = table.querySelector('tbody tr').cloneNode(true);
      row.querySelectorAll('input').forEach(inp => inp.value = '');
      table.querySelector('tbody').appendChild(row);
    }

    function addColumn(tableId) {
      const table = document.getElementById(tableId);
      const th = document.createElement('th');
      th.textContent = 'New';
      table.querySelector('thead tr').appendChild(th);
      table.querySelectorAll('tbody tr').forEach(tr => {
        const td = document.createElement('td');
        const inp = document.createElement('input');
        inp.type = 'text';
        td.appendChild(inp);
        tr.appendChild(td);
      });
    }

    function prepareDriverCsv() {
      document.getElementById('driver-data-hidden').value = tableToCSV('driver-table');
    }

    function prepareConstructorCsv() {
      document.getElementById('constructor-data-hidden').value = tableToCSV('constructor-table');
    }

    function prepareCalendarCsv() {
      document.getElementById('calendar-data-hidden').value = tableToCSV('calendar-table');
    }

    function prepareTracksCsv() {
      document.getElementById('tracks-data-hidden').value = tableToCSV('tracks-table');
    }

    function prepareMappingCsv() {
      document.getElementById('mapping-data-hidden').value = tableToCSV('mapping-table');
    }

    function prepareSimpleMatrixCsv() {
      document.getElementById('simple-matrix-data-hidden').value = tableToCSV('simple-matrix-table');
    }

    async function loadQueuedTasks() {
      try {
        const resp = await fetch('/api/tasks');
        const data = await resp.json();
        if (data.success) {
          const tbody = document.createElement('tbody');
          data.tasks.forEach(t => {
            const tr = document.createElement('tr');
            const tdId = document.createElement('td');
            tdId.textContent = t.id;
            const tdUser = document.createElement('td');
            tdUser.textContent = t.user;
            const tdCreated = document.createElement('td');
            tdCreated.textContent = t.created;
            tr.appendChild(tdId);
            tr.appendChild(tdUser);
            tr.appendChild(tdCreated);
            tbody.appendChild(tr);
          });
          const table = document.getElementById('tasks-table');
          table.innerHTML = '';
          const thead = document.createElement('thead');
          const headRow = document.createElement('tr');
          ['ID','User','Created'].forEach(h => {
            const th = document.createElement('th');
            th.textContent = h;
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);
          table.appendChild(thead);
          table.appendChild(tbody);
        }
      } catch(e) {
        console.error(e);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      buildTable(driverCSV, 'driver-table');
      buildTable(constructorCSV, 'constructor-table');
      buildTable(calendarCSV, 'calendar-table');
      buildTable(tracksCSV, 'tracks-table');
      buildTable(mappingCSV, 'mapping-table');
      buildTable(simpleMatrixCSV, 'simple-matrix-table');
      loadQueuedTasks();
    });
  </script>
{% endblock %}
