<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Race Data</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <div class="header-content">
      <h1>Manage Race Data</h1>
      <nav class="nav-links">
        <a href="/">Optimiser</a>
        <a href="/statistics">Statistics</a>
        <a href="/manage_data" class="active">Data Editor</a>
      </nav>
    </div>
  </header>

  <div class="container">
    {% if message %}
    <div class="info">{{ message }}</div>
    {% endif %}
    <div class="section">
      <h2>Driver Race Data</h2>
      <form method="post" action="/save_driver_data" onsubmit="prepareDriverCsv()">
        <table id="driver-table" class="data-table"></table>
        <input type="hidden" name="driver_data" id="driver-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('driver-table')">Add Row</button>
          <button class="button" type="submit">Save Drivers</button>
        </div>
      </form>
    </div>

    <div class="section">
      <h2>Constructor Race Data</h2>
      <form method="post" action="/save_constructor_data" onsubmit="prepareConstructorCsv()">
        <table id="constructor-table" class="data-table"></table>
        <input type="hidden" name="constructor_data" id="constructor-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('constructor-table')">Add Row</button>
          <button class="button" type="submit">Save Constructors</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const driverCSV = {{ driver_csv|tojson|safe }};
    const constructorCSV = {{ constructor_csv|tojson|safe }};

    function parseCSV(text) {
      return text.trim().split(/\r?\n/).map(r => r.split(','));
    }

    function buildTable(csv, tableId) {
      const rows = csv ? parseCSV(csv) : [];
      const table = document.getElementById(tableId);
      table.innerHTML = '';
      if (!rows.length) return;
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      rows[0].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      for (let i = 1; i < rows.length; i++) {
        const tr = document.createElement('tr');
        rows[i].forEach(cell => {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'text';
          input.value = cell;
          td.appendChild(input);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
    }

    function tableToCSV(tableId) {
      const table = document.getElementById(tableId);
      const rows = [];
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
      rows.push(headers.join(','));
      table.querySelectorAll('tbody tr').forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('td input')).map(inp => inp.value);
        rows.push(cells.join(','));
      });
      return rows.join('\n');
    }

    function addRow(tableId) {
      const table = document.getElementById(tableId);
      const headerCount = table.querySelectorAll('thead th').length;
      const tr = document.createElement('tr');
      for (let i = 0; i < headerCount; i++) {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        td.appendChild(input);
        tr.appendChild(td);
      }
      table.querySelector('tbody').appendChild(tr);
    }

    function prepareDriverCsv() {
      document.getElementById('driver-data-hidden').value = tableToCSV('driver-table');
    }

    function prepareConstructorCsv() {
      document.getElementById('constructor-data-hidden').value = tableToCSV('constructor-table');
    }

    document.addEventListener('DOMContentLoaded', () => {
      buildTable(driverCSV, 'driver-table');
      buildTable(constructorCSV, 'constructor-table');
    });
  </script>
</body>
</html>
