<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='90' font-size='90'%3E🏎️%3C/text%3E%3C/svg%3E"
  >
  <title>Administration</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <div class="header-content">
    <h1>Administration</h1>
      <button class="nav-toggle" onclick="toggleNav()">&#9776;</button>
      <nav class="nav-links">
        {% if current_user.is_authenticated %}
          <a href="/">Home</a>
          <a href="/optimizer">Optimiser</a>
          <a href="/statistics">Statistics</a>
          {% if current_user.admin %}
          <a href="/manage_data" class="active">Administration</a>
          {% endif %}
          <a href="/account">Account</a>
          <a href="/logout">Logout</a>
        {% else %}
          <a href="/">Home</a>
          <a href="/login">Login</a>
        {% endif %}
      </nav>
    </div>
  </header>

  <div class="container">
    {% if message %}
    <div class="info">{{ message }}</div>
    {% endif %}
    <details class="admin-section">
      <summary>Driver Race Data</summary>
      <div class="section">
      <form method="post" action="/save_driver_data" onsubmit="prepareDriverCsv()">
        <input type="file" accept=".csv" onchange="loadCsv(event,'driver-table')" />
        <table id="driver-table" class="data-table"></table>
        <input type="hidden" name="driver_data" id="driver-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('driver-table')">Add Row</button>
          <button type="button" class="button-secondary" onclick="addColumn('driver-table')">Add Column</button>
          <button class="button" type="submit">Save Drivers</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>Constructor Race Data</summary>
      <div class="section">
      <form method="post" action="/save_constructor_data" onsubmit="prepareConstructorCsv()">
        <input type="file" accept=".csv" onchange="loadCsv(event,'constructor-table')" />
        <table id="constructor-table" class="data-table"></table>
        <input type="hidden" name="constructor_data" id="constructor-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('constructor-table')">Add Row</button>
          <button type="button" class="button-secondary" onclick="addColumn('constructor-table')">Add Column</button>
          <button class="button" type="submit">Save Constructors</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>Race Calendar</summary>
      <div class="section">
      <form method="post" action="/save_calendar_data" onsubmit="prepareCalendarCsv()">
        <input type="file" accept=".csv" onchange="loadCsv(event,'calendar-table')" />
        <table id="calendar-table" class="data-table"></table>
        <input type="hidden" name="calendar_data" id="calendar-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('calendar-table')">Add Row</button>
          <button type="button" class="button-secondary" onclick="addColumn('calendar-table')">Add Column</button>
          <button class="button" type="submit">Save Calendar</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>Track Characteristics</summary>
      <div class="section">
      <form method="post" action="/save_tracks_data" onsubmit="prepareTracksCsv()">
        <input type="file" accept=".csv" onchange="loadCsv(event,'tracks-table')" />
        <table id="tracks-table" class="data-table"></table>
        <input type="hidden" name="tracks_data" id="tracks-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('tracks-table')">Add Row</button>
          <button type="button" class="button-secondary" onclick="addColumn('tracks-table')">Add Column</button>
          <button class="button" type="submit">Save Tracks</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>Driver Number Mapping</summary>
      <div class="section">
      <form method="post" action="/save_mapping_data" onsubmit="prepareMappingCsv()">
        <input type="file" accept=".csv" onchange="loadCsv(event,'mapping-table')" />
        <table id="mapping-table" class="data-table"></table>
        <input type="hidden" name="mapping_data" id="mapping-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('mapping-table')">Add Row</button>
          <button type="button" class="button-secondary" onclick="addColumn('mapping-table')">Add Column</button>
          <button class="button" type="submit">Save Mapping</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>Simple Configuration Matrix</summary>
      <div class="section">
      <form method="post" action="/save_simple_config_matrix" onsubmit="prepareSimpleMatrixCsv()">
        <input type="file" accept=".csv" onchange="loadCsv(event,'simple-matrix-table')" />
        <table id="simple-matrix-table" class="data-table"></table>
        <input type="hidden" name="simple_matrix_data" id="simple-matrix-data-hidden">
        <div class="button-group">
          <button type="button" class="button-secondary" onclick="addRow('simple-matrix-table')">Add Row</button>
          <button type="button" class="button-secondary" onclick="addColumn('simple-matrix-table')">Add Column</button>
          <button class="button" type="submit">Save Matrix</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>Optimisation Parameters</summary>
      <div class="section">
      <form method="post" action="/save_opt_settings">
        <div class="form-group">
          <label for="outlier_stddev_factor">Outlier StdDev Factor</label>
          <input type="number" step="0.1" name="outlier_stddev_factor" id="outlier_stddev_factor" value="{{ settings.outlier_stddev_factor }}">
        </div>
        <div class="form-group">
          <label for="trend_slope_threshold">Trend Slope Threshold</label>
          <input type="number" step="0.1" name="trend_slope_threshold" id="trend_slope_threshold" value="{{ settings.trend_slope_threshold }}">
        </div>
        <div class="form-group">
          <label for="recent_races_fraction">Recent Races Fraction</label>
          <input type="number" step="0.1" name="recent_races_fraction" id="recent_races_fraction" value="{{ settings.recent_races_fraction }}">
        </div>
        <div class="form-group">
          <label for="long_term_weight">Long-Term Weight</label>
          <input type="number" step="0.1" name="long_term_weight" id="long_term_weight" value="{{ settings.long_term_weight }}">
        </div>
        <div class="form-group">
          <label for="interaction_weight">Interaction Weight</label>
          <input type="number" step="0.1" name="interaction_weight" id="interaction_weight" value="{{ settings.interaction_weight }}">
        </div>
        <div class="form-group">
          <label for="top_n_candidates">Candidate Pool Size</label>
          <input type="number" name="top_n_candidates" id="top_n_candidates" value="{{ settings.top_n_candidates }}" min="1">
        </div>
        <div class="checkbox-group">
          <label>
            <input type="checkbox" name="use_ilp" id="use_ilp" {% if settings.use_ilp %}checked{% endif %}>
            Use ILP-based optimisation (experimental)
          </label>
        </div>
        <div class="button-group">
          <button class="button" type="submit">Save Settings</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>API Settings</summary>
      <div class="section">
      <form method="post" action="/save_api_settings">
        <div class="form-group">
          <label for="openf1_base_url">OpenF1 Base URL</label>
          <input type="text" name="openf1_base_url" id="openf1_base_url" value="{{ settings.openf1_base_url }}">
        </div>
        <div class="form-group">
          <label for="poll_interval_minutes">API Poll Interval (minutes)</label>
          <input type="number" name="poll_interval_minutes" id="poll_interval_minutes" value="{{ settings.poll_interval_minutes }}" min="1">
        </div>
        <div class="form-group">
          <label for="lap_stale_minutes">Lap Stale Threshold (minutes)</label>
          <input type="number" name="lap_stale_minutes" id="lap_stale_minutes" value="{{ settings.lap_stale_minutes }}" min="1">
        </div>
        <div class="button-group">
          <button class="button" type="submit">Save Settings</button>
        </div>
      </form>
      </div>
    </details>

    <details class="admin-section">
      <summary>SMTP Settings</summary>
      <div class="section">
      <form method="post" action="/save_smtp_settings">
        <div class="form-group">
          <label for="smtp_host">SMTP Host</label>
          <input type="text" name="smtp_host" id="smtp_host" value="{{ settings.smtp_host }}">
        </div>
        <div class="form-group">
          <label for="smtp_port">SMTP Port</label>
          <input type="number" name="smtp_port" id="smtp_port" value="{{ settings.smtp_port }}">
        </div>
        <div class="form-group">
          <label for="smtp_username">SMTP Username</label>
          <input type="text" name="smtp_username" id="smtp_username" value="{{ settings.smtp_username }}">
        </div>
        <div class="form-group">
          <label for="smtp_from">Sender Address</label>
          <input type="text" name="smtp_from" id="smtp_from" value="{{ settings.smtp_from }}">
        </div>
        <div class="form-group">
          <label for="smtp_password">SMTP Password</label>
          <input type="password" name="smtp_password" id="smtp_password" value="{{ settings.smtp_password }}">
        </div>
        <div class="checkbox-group">
          <label>
            <input type="checkbox" name="smtp_tls" id="smtp_tls" {% if settings.smtp_tls %}checked{% endif %}>
            Use TLS
          </label>
        </div>
        <div class="button-group">
          <button class="button" type="submit">Save Settings</button>
          <button type="button" class="button-secondary" onclick="sendTestEmail()">Send Test Email</button>
        </div>
      </form>
      </div>
    </details>


    <details class="admin-section">
      <summary>Queued Email Optimisations</summary>
      <div class="section">
      <div class="button-group" style="margin-bottom:10px;">
        <button type="button" class="button-secondary" onclick="loadQueuedTasks()">Refresh List</button>
      </div>
      <table id="tasks-table" class="data-table"></table>
      </div>
    </details>
  </div>

  <script>
    const driverCSV = {{ driver_csv|tojson|safe }};
    const constructorCSV = {{ constructor_csv|tojson|safe }};
    const calendarCSV = {{ calendar_csv|tojson|safe }};
    const tracksCSV = {{ tracks_csv|tojson|safe }};
    const mappingCSV = {{ mapping_csv|tojson|safe }};
    const simpleMatrixCSV = {{ simple_matrix_csv|tojson|safe }};

    function parseCSV(text) {
      return text.trim().split(/\r?\n/).map(r => r.split(','));
    }

    function buildTable(csv, tableId) {
      const rows = csv ? parseCSV(csv) : [];
      const table = document.getElementById(tableId);
      table.innerHTML = '';
      if (!rows.length) return;
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      rows[0].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      for (let i = 1; i < rows.length; i++) {
        const tr = document.createElement('tr');
        rows[i].forEach(cell => {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'text';
          input.value = cell;
          td.appendChild(input);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
    }

    function tableToCSV(tableId) {
      const table = document.getElementById(tableId);
      const rows = [];
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
      rows.push(headers.join(','));
      table.querySelectorAll('tbody tr').forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('td input')).map(inp => inp.value);
        rows.push(cells.join(','));
      });
      return rows.join('\n');
    }

    function addRow(tableId) {
      const table = document.getElementById(tableId);
      const headerCount = table.querySelectorAll('thead th').length;
      const tr = document.createElement('tr');
      for (let i = 0; i < headerCount; i++) {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        td.appendChild(input);
        tr.appendChild(td);
      }
      table.querySelector('tbody').appendChild(tr);
    }

    function addColumn(tableId) {
      const table = document.getElementById(tableId);
      const headerRow = table.querySelector('thead tr');
      if (!headerRow) return;
      const colName = prompt('Column name?');
      if (!colName) return;
      const th = document.createElement('th');
      th.textContent = colName;
      headerRow.appendChild(th);
      table.querySelectorAll('tbody tr').forEach(tr => {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        td.appendChild(input);
        tr.appendChild(td);
      });
    }

    function loadCsv(event, tableId) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => buildTable(e.target.result, tableId);
      reader.readAsText(file);
    }

    function prepareDriverCsv() {
      document.getElementById('driver-data-hidden').value = tableToCSV('driver-table');
    }

    function prepareConstructorCsv() {
      document.getElementById('constructor-data-hidden').value = tableToCSV('constructor-table');
    }

    function prepareCalendarCsv() {
      document.getElementById('calendar-data-hidden').value = tableToCSV('calendar-table');
    }

    function prepareTracksCsv() {
      document.getElementById('tracks-data-hidden').value = tableToCSV('tracks-table');
    }

    function prepareMappingCsv() {
      document.getElementById('mapping-data-hidden').value = tableToCSV('mapping-table');
    }

    function prepareSimpleMatrixCsv() {
      document.getElementById('simple-matrix-data-hidden').value = tableToCSV('simple-matrix-table');
    }

    async function sendTestEmail() {
      try {
        const resp = await fetch('/send_test_email', { method: 'POST' });
        const data = await resp.json();
        if (data.success) {
          alert('Test email sent. Check your inbox.');
        } else {
          alert('Failed to send test email: ' + (data.message || 'unknown error'));
        }
      } catch (err) {
        alert('Failed to send test email: ' + err.message);
      }
    }

    async function loadQueuedTasks() {
      try {
        const resp = await fetch('/queued_email_tasks');
        const data = await resp.json();
        const table = document.getElementById('tasks-table');
        table.innerHTML = '';
        if (!data.success) {
          table.textContent = data.message || 'Failed to load tasks';
          return;
        }
        if (!data.tasks.length) {
          table.textContent = 'No tasks queued.';
          return;
        }
        const thead = document.createElement('thead');
        const hrow = document.createElement('tr');
        ['ID','User','Session','Created','Status','Config','Action'].forEach(h => {
            const th = document.createElement('th');
            th.textContent = h;
            hrow.appendChild(th);
        });
        thead.appendChild(hrow);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        data.tasks.forEach(t => {
          const tr = document.createElement('tr');
          [t.id, t.user, t.session_id, t.created_at, t.status, JSON.stringify(t.config)].forEach(val => {
            const td = document.createElement('td');
            td.textContent = val;
            tr.appendChild(td);
          });
          const cancelTd = document.createElement('td');
          const btn = document.createElement('button');
          btn.textContent = 'Cancel';
          btn.className = 'button-secondary';
          btn.onclick = async () => {
            if (!confirm(`Cancel task ${t.id}?`)) return;
            try {
              const resp = await fetch('/cancel_email_task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_id: t.id })
              });
              const res = await resp.json();
              if (res.success) {
                tr.remove();
              } else {
                alert('Failed to cancel: ' + (res.message || 'unknown error'));
              }
            } catch (err) {
              alert('Failed to cancel: ' + err.message);
            }
          };
          cancelTd.appendChild(btn);
          tr.appendChild(cancelTd);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
      } catch (err) {
        const table = document.getElementById('tasks-table');
        table.textContent = 'Error loading tasks: ' + err.message;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      buildTable(driverCSV, 'driver-table');
      buildTable(constructorCSV, 'constructor-table');
      buildTable(calendarCSV, 'calendar-table');
      buildTable(tracksCSV, 'tracks-table');
      buildTable(mappingCSV, 'mapping-table');
      buildTable(simpleMatrixCSV, 'simple-matrix-table');
  loadQueuedTasks();
  });
  </script>
  <script>
    function toggleNav() {
      document.querySelector('.nav-links').classList.toggle('open');
    }
  </script>
</body>
</html>
